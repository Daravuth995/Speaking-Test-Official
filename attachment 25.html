<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IELTS-Style Test Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Serif:wght@600;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #d32c2c;
      --primary-dark: #900808;
      --text-color: #19191a;
      --light-bg: #f5f5f8;
      --card-bg: #fff;
      --correct-color: #098d37;
      --wrong-color: #d32c2c;
      --warning-color: #ff9800;
    }
    
    body { 
      background: #fff; 
      color: var(--text-color); 
      margin: 0; 
      font-family: 'Roboto', Arial, sans-serif; 
      scroll-behavior: smooth;
    }
    
    .centered { 
      min-height: 100vh; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      background: var(--light-bg); 
    }
    
    #loginBox { 
      background: var(--card-bg); 
      border: 2px solid #e3e4e8; 
      border-radius: 20px; 
      box-shadow: 0 2px 16px #e3e3e3; 
      padding: 2.5rem 2rem; 
      width: 96vw; 
      max-width: 400px; 
      margin-top: 2rem; 
    }
    
    #loginBox h2 { 
      text-align: center; 
      margin-bottom: 1.3rem; 
      color: var(--primary-color); 
      font-family: 'Roboto Serif', serif; 
      font-weight: 700; 
      letter-spacing: 0.7px; 
    }
    
    #loginBox input { 
      background: #f5f5f5; 
      color: var(--text-color); 
      border: 1.2px solid #e3e4e8; 
      outline: none; 
      font-size: 1rem; 
      padding: .7rem .85rem; 
      margin: .5rem 0; 
      border-radius: 7px; 
      width: 100%; 
      font-family: inherit; 
      font-weight: 600; 
      transition: border .2s; 
    }
    
    #loginBox input:focus { 
      border: 1.5px solid var(--primary-color); 
      background: #faf5f5; 
    }
    
    #loginBox button { 
      margin-top: 1rem; 
      font-size: 1.11rem; 
      font-weight: 700; 
      padding: 0.82rem; 
      border-radius: 8px; 
      background: var(--primary-color); 
      color: #fff; 
      border: none; 
      cursor: pointer; 
      letter-spacing: 0.5px; 
      transition: background .15s; 
    }
    
    #loginBox button:active { 
      background: var(--primary-dark); 
    }
    
    #loginError { 
      color: var(--primary-color); 
      margin-top: 0.8rem; 
      text-align: center; 
      font-weight: 600; 
      min-height: 1.3rem; 
      font-size: 1rem; 
    }
    
    #loginLoading { 
      display: none; 
      justify-content: center; 
      align-items: center; 
      margin-top: 1.2rem; 
      margin-bottom: -0.5rem; 
    }
    
    .spinner { 
      border: 4px solid #f3d6d7; 
      border-top: 4px solid var(--primary-color); 
      border-radius: 50%; 
      width: 2.3rem; 
      height: 2.3rem; 
      animation: spin 1.1s linear infinite; 
      margin: auto; 
    }
    
    @keyframes spin { 
      0% { transform: rotate(0); } 
      100% { transform: rotate(360deg); } 
    }
    
    #dashboard { 
      display: none; 
      background: var(--card-bg); 
      max-width: 740px; 
      margin: 2.8rem auto 0 auto; 
      border: 2px solid var(--primary-color); 
      border-radius: 18px; 
      box-shadow: 0 4px 30px #e7e7e7; 
      padding: 0 0 0 0; 
      animation: fade-in .9s; 
      position: relative; 
    }
    
    @keyframes fade-in { 
      0% { opacity: 0; } 
      100% { opacity: 1; } 
    }
    
    .testHeader { 
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex; 
      align-items: center; 
      background: var(--primary-color); 
      color: #fff; 
      border-radius: 15px 15px 0 0; 
      padding: 1.2rem 2.1rem 1rem 2.1rem; 
      border-bottom: 5px solid #ad1111; 
      font-family: 'Roboto Serif', serif; 
      font-size: 1.45rem; 
      font-weight: 700; 
      letter-spacing: 1.3px; 
      justify-content: space-between; 
    }
    
    .testHeader .ieltsMark { 
      font-size: 1.1rem; 
      background: #fff; 
      color: var(--primary-color); 
      border-radius: 7px; 
      padding: 0.13em 0.9em 0.13em 0.9em; 
      font-family: 'Roboto', sans-serif; 
      font-weight: 700; 
      letter-spacing: 0.1em; 
      margin-left: 0.6rem; 
    }
    
    #timerContainer {
      background: linear-gradient(135deg, #fff 0%, #f8f8f8 100%);
      padding: 0.5rem 1.4rem;
      border-radius: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      font-weight: 700;
      color: var(--text-color);
      border: 2px solid var(--primary-color);
      display: flex;
      align-items: center;
      gap: 0.7rem;
      margin-left: auto;
      transition: all 0.3s ease;
    }
    
    #timerContainer i {
      color: var(--primary-color);
      font-size: 1.1em;
    }
    
    #timerDisplay {
      font-family: 'Roboto Mono', monospace;
      font-size: 1.05em;
      letter-spacing: 0.5px;
    }
    
    #timerContainer.warning {
      color: var(--warning-color);
      border-color: var(--warning-color);
      animation: pulse 1s infinite;
      background: linear-gradient(135deg, #fff9e6 0%, #fff4d4 100%);
    }
    
    #timerContainer.warning i {
      color: var(--warning-color);
    }
    
    #timerContainer.danger {
      color: var(--wrong-color);
      border-color: var(--wrong-color);
      animation: pulse 0.5s infinite;
      background: linear-gradient(135deg, #ffebeb 0%, #ffe0e0 100%);
    }
    
    #timerContainer.danger i {
      color: var(--wrong-color);
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    #welcomeBar { 
      position: sticky;
      top: 70px;
      z-index: 90;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(8px);
      display: flex; 
      align-items: center; 
      gap: 1rem; 
      margin: 0 2rem;
      padding: 1.2rem 0;
      justify-content: flex-end; 
      border-bottom: 1px solid #f0f0f0;
    }
    
    .userBadge { 
      background: #f7d7d7; 
      color: var(--primary-color); 
      padding: 0.35rem 1rem; 
      border-radius: 12px; 
      font-size: 1.08rem; 
      font-weight: 700; 
      letter-spacing: 0.4px; 
      display: flex; 
      align-items: center; 
      gap: 0.62rem; 
      border: 1px solid #d32c2c44; 
      box-shadow: 0 2px 8px #d32c2c18; 
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .userBadge:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px #d32c2c25;
    }
    
    .userBadge i { 
      font-size: 1.2em; 
      color: var(--primary-color); 
    }
    
    #testForm { 
      margin: 0 2.2rem; 
      padding: 1rem 0;
    }
    
    .questionCard { 
      background: #fcf6f6; 
      border: 1.2px solid #d32c2c33; 
      margin: 1.5rem 0 2rem 0; 
      padding: 1.1rem 1.4rem 1.5rem 1.4rem; 
      border-radius: 12px; 
      box-shadow: 0 2px 10px #f8caca14; 
      font-family: 'Roboto Serif', serif; 
      font-size: 1.14rem; 
      font-weight: 600; 
      color: var(--text-color); 
      position: relative; 
      transition: box-shadow .15s; 
    }
    
    .questionCard:hover {
      box-shadow: 0 4px 15px #f8caca30;
    }
    
    .questionCard label { 
      font-size: 1.06rem; 
      font-family: 'Roboto', Arial, sans-serif; 
      font-weight: 500; 
      color: #351010; 
      padding-left: 2px; 
      margin-right: 1.8rem; 
      margin-bottom: 0.7em; 
      display: inline-block; 
      cursor: pointer;
      transition: color 0.2s;
    }
    
    .questionCard label:hover {
      color: var(--primary-color);
    }
    
    .questionCard input[type="radio"] {
      margin-right: 0.6rem;
      transform: scale(1.1);
      cursor: pointer;
    }
    
    .audio-container {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin: 1rem 0;
    }
    
    .audioBtn { 
      background: #e3e4e8; 
      color: var(--primary-color); 
      border: none; 
      border-radius: 8px; 
      padding: 0.7rem 1.5rem; 
      font-size: 1rem; 
      font-weight: 600; 
      box-shadow: 0 1.5px 7px #d32c2c11; 
      border: 1px solid #d32c2c22; 
      transition: all .2s; 
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.7rem;
      position: relative;
      overflow: hidden;
    }
    
    .audioBtn:hover { 
      background: #f5e5e5; 
      color: var(--primary-dark); 
      transform: translateY(-1px);
    }
    
    .audioBtn.playing {
      background: var(--primary-color);
      color: white;
      animation: pulse-glow 1.5s infinite;
    }
    
    .audioBtn.loading::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.8);
      z-index: 1;
    }
    
    .audioBtn.loading::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 20px;
      height: 20px;
      border: 3px solid rgba(211, 44, 44, 0.2);
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      z-index: 2;
    }
    
    @keyframes pulse-glow {
      0% { box-shadow: 0 0 0 0 rgba(211, 44, 44, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(211, 44, 44, 0); }
      100% { box-shadow: 0 0 0 0 rgba(211, 44, 44, 0); }
    }
    
    .audio-progress {
      flex-grow: 1;
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
      position: relative;
    }
    
    .audio-progress-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: var(--primary-color);
      width: 0%;
      transition: width 0.1s linear;
    }
    
    .audio-time {
      font-size: 0.9rem;
      color: #666;
      min-width: 80px;
      text-align: right;
    }
    
    #submitBtn { 
      margin: 1.8rem auto 0.5rem auto; 
      display: block; 
      font-size: 1.13rem; 
      background: var(--primary-color); 
      color: #fff; 
      font-weight: 700; 
      border: none; 
      border-radius: 11px; 
      padding: 0.97rem 2.3rem; 
      box-shadow: 0 4px 14px #d32c2c44; 
      cursor: pointer; 
      letter-spacing: 0.2px; 
      font-family: 'Roboto', Arial, sans-serif; 
      transition: all .2s; 
    }
    
    #submitBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 18px #d32c2c55;
    }
    
    #submitBtn:active { 
      background: var(--primary-dark);
      transform: translateY(0);
    }
    
    #submitBtn:disabled { 
      background: #cccccc; 
      cursor: not-allowed; 
      transform: none;
      box-shadow: none;
    }
    
    #submitLoading { 
      display: none; 
      margin: 1rem auto; 
      text-align: center; 
    }
    
    #scoreResult { 
      font-size: 1.35rem; 
      font-family: 'Roboto Serif', serif; 
      font-weight: 800; 
      color: var(--primary-color); 
      text-align: center; 
      margin: 2.3rem 0 0.7rem 0; 
      animation: fade-in .7s; 
      letter-spacing: 0.5px; 
      padding: 1.5rem;
      background: #fcf6f6;
      border-radius: 12px;
      border: 1px solid #d32c2c22;
      box-shadow: 0 4px 16px rgba(211, 44, 44, 0.1);
      position: relative;
    }
    
    .score-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #d32c2c22;
    }
    
    .score-user {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .score-value {
      font-size: 2.2rem;
      font-weight: 800;
      color: var(--primary-color);
      margin: 0.5rem 0;
      background: linear-gradient(135deg, #f8e1e1 0%, #f5d6d6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .score-label {
      font-size: 1rem;
      color: #666;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    
    .score-details {
      display: flex;
      justify-content: space-between;
      margin-top: 1.2rem;
      padding-top: 1rem;
      border-top: 1px dashed #d32c2c33;
    }
    
    .score-detail-item {
      flex: 1;
      text-align: center;
      padding: 0.5rem;
    }
    
    .score-detail-value {
      font-weight: 700;
      color: var(--primary-color);
      font-size: 1.1rem;
    }
    
    .score-detail-label {
      font-size: 0.85rem;
      color: #666;
    }
    
    .answerResult { 
      margin-top: 0.45rem; 
      font-size: 1.04rem; 
      font-weight: 600; 
      padding: 0.28rem 0.75rem; 
      border-radius: 9px; 
      display: inline-block; 
      box-shadow: 0 1.5px 8px #d32c2c14; 
      animation: fade-in 0.6s; 
      font-family: 'Roboto', Arial, sans-serif; 
      margin-left: 0.2rem; 
    }
    
    .answerCorrect { 
      background: #f7fffa; 
      color: var(--correct-color); 
      border: 1.2px solid #55bc6f; 
    }
    
    .answerWrong { 
      background: #fff1f1; 
      color: var(--wrong-color); 
      border: 1.2px solid #d32c2c77; 
    }
    
    #restrictionOverlay { 
      display: none; 
      position: fixed; 
      z-index: 9999; 
      left: 0; 
      top: 0; 
      width: 100vw; 
      height: 100vh; 
      background: rgba(211,44,44,0.11); 
      color: var(--primary-color); 
      justify-content: center; 
      align-items: center; 
      flex-direction: column; 
      backdrop-filter: blur(9px) brightness(0.93); 
      animation: fade-in 0.4s; 
    }
    
    #agreementOverlay {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
      animation: fade-in 0.3s;
    }
    
    .agreementCard {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      padding: 2rem;
      max-width: 600px;
      width: 90vw;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }
    
    .agreementHeader {
      text-align: center;
      margin-bottom: 1.5rem;
      color: var(--primary-color);
      font-family: 'Roboto Serif', serif;
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    .agreementContent {
      margin-bottom: 2rem;
      line-height: 1.6;
      font-size: 0.95rem;
      color: #444;
    }
    
    .agreementCheckbox {
      margin: 1rem 0;
      display: flex;
      align-items: center;
    }
    
    .agreementCheckbox input {
      margin-right: 0.8rem;
      transform: scale(1.2);
    }
    
    .agreementCheckbox label {
      font-weight: 600;
      color: var(--text-color);
    }
    
    .agreementActions {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 1.5rem;
    }
    
    .agreementBtn {
      padding: 0.8rem 1.8rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    
    .agreementBtn.primary {
      background: var(--primary-color);
      color: white;
    }
    
    .agreementBtn.primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }
    
    .agreementBtn.secondary {
      background: #f0f0f0;
      color: #555;
    }
    
    .agreementBtn.secondary:hover {
      background: #e0e0e0;
    }
    
    .restrictCard { 
      background: #fff8f7; 
      border-radius: 1.2rem; 
      box-shadow: 0 4px 34px #d32c2c19; 
      border: 2px solid #d32c2c55; 
      padding: 2rem 2.2rem 1.5rem 2.2rem; 
      text-align: center; 
      min-width: 260px; 
      max-width: 90vw; 
      color: var(--primary-color); 
      font-family: 'Roboto Serif', serif; 
    }
    
    .restrictCard .iconWrap { 
      margin-bottom: 1.1rem; 
      background: #fff1f1; 
      border-radius: 50%; 
      padding: 0.7rem 1.3rem; 
      box-shadow: 0 2px 7px #d32c2c18; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
    }
    
    .restrictMsg { 
      margin-top: .9rem; 
      font-size: 1.12rem; 
      font-weight: 600; 
      color: #ad1111; 
      word-break: break-word; 
      animation: fade-in .7s; 
    }
    
    #submissionOverlay { 
      display: none; 
      position: fixed; 
      z-index: 9998; 
      left: 0; 
      top: 0; 
      width: 100vw; 
      height: 100vh; 
      background: rgba(211,44,44,0.08); 
      justify-content: center; 
      align-items: center; 
      flex-direction: column; 
      backdrop-filter: blur(8px) brightness(0.96); 
      animation: fade-in 0.3s; 
    }
    
    .submissionCard { 
      background: rgba(255, 248, 248, 0.95); 
      border-radius: 1.2rem; 
      box-shadow: 0 8px 32px rgba(211, 44, 44, 0.2); 
      border: 2px solid rgba(211, 44, 44, 0.2); 
      padding: 2.2rem 2.5rem; 
      text-align: center; 
      min-width: 300px; 
      max-width: 85vw; 
      color: var(--primary-color); 
      font-family: 'Roboto', sans-serif; 
    }
    
    .submissionCard .spinner { 
      border-top-color: var(--primary-color); 
      margin-bottom: 1.5rem; 
      width: 3rem; 
      height: 3rem; 
      border-width: 5px; 
    }
    
    .submissionMsg { 
      font-size: 1.18rem; 
      font-weight: 600; 
      margin-top: 0.5rem; 
      min-height: 2.5rem; 
    }
    
    /* Drag and drop answer styles */
    .drag-drop-container {
      margin: 1rem 0;
    }
    
    .drag-drop-options {
      display: flex;
      flex-wrap: wrap;
      gap: 0.8rem;
      margin-bottom: 1.5rem;
    }
    
    .drag-option {
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 0.6rem 1rem;
      cursor: grab;
      font-size: 1rem;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .drag-option:hover {
      background: #e9e9e9;
      transform: translateY(-2px);
    }
    
    .drag-option:active {
      cursor: grabbing;
    }
    
    .drag-drop-target {
      min-height: 50px;
      border: 2px dashed #d32c2c55;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
      background: #fff9f9;
      transition: all 0.2s;
    }
    
    .drag-drop-target.active {
      background: #fff1f1;
      border-color: var(--primary-color);
    }
    
    .long-paragraph {
      max-width: 100%;
      overflow-wrap: break-word;
      line-height: 1.6;
      padding: 0.8rem 1rem;
      background: #f9f9f9;
      border-radius: 8px;
      border-left: 4px solid var(--primary-color);
      margin: 1rem 0;
    }
    
    .screenshot-btn {
      margin: 1.5rem auto 0 auto;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.7rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(211, 44, 44, 0.2);
    }
    
    .screenshot-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(211, 44, 44, 0.3);
    }
    
    .screenshot-btn:active {
      transform: translateY(0);
    }
    
    @media (max-width:750px) { 
      #dashboard { margin:1rem 0; } 
      .testHeader, #welcomeBar, #testForm { margin-left: 0.3em !important; margin-right: 0.3em !important; } 
      #testForm { margin:0.7em; } 
      .testHeader { font-size: 1.3rem; padding: 1rem 1.5rem; }
      #welcomeBar { top: 60px; padding: 1rem 0; }
      #timerContainer {
        top: -25px;
        padding: 0.4rem 1.2rem;
        font-size: 0.9rem;
      }
      .agreementCard {
        padding: 1.5rem;
      }
      .agreementHeader {
        font-size: 1.3rem;
      }
    }
    
    @media (max-width:480px) { 
      #testForm { padding:0; } 
      #dashboard { border-radius: 0; } 
      .submissionCard { padding: 1.8rem 1.5rem; } 
      .submissionMsg { font-size: 1.1rem; } 
      .questionCard { padding: 1rem 1rem 1.3rem 1rem; }
      .audio-container {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      .audio-progress {
        width: 100%;
      }
      #timerContainer {
        top: -20px;
        padding: 0.3rem 1rem;
        font-size: 0.85rem;
      }
      .agreementActions {
        flex-direction: column;
        gap: 0.7rem;
      }
      .agreementBtn {
        width: 100%;
      }
      .score-header {
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <div id="restrictionOverlay"></div>
  <div id="agreementOverlay">
    <div class="agreementCard">
      <div class="agreementHeader">
        <i class="fas fa-file-contract" style="margin-right: 0.7rem;"></i>Test Agreement
      </div>
      <div class="agreementContent">
        <p>Welcome to the IELTS-Style Speaking Test. Before proceeding, please read and agree to the following terms:</p>
        
        <h4>Test Rules:</h4>
        <ul>
          <li>This test must be completed in one session - you cannot pause and return later</li>
          <li>All answers must be your own work - no external assistance is permitted</li>
          <li>You must complete the test within the allotted time</li>
          <li>Only one attempt is allowed per student</li>
        </ul>
        
        <h4>Academic Integrity:</h4>
        <p>By taking this test, you agree that all responses are your own original work. Any violation of academic integrity may result in disciplinary action.</p>
        
        <h4>Technical Requirements:</h4>
        <ul>
          <li>Stable internet connection required</li>
          <li>Modern browser recommended (Chrome, Firefox, Edge)</li>
          <li>Headphones recommended for audio questions</li>
        </ul>
        
        <div class="agreementCheckbox">
          <input type="checkbox" id="agreeCheckbox">
          <label for="agreeCheckbox">I have read and agree to the terms above</label>
        </div>
      </div>
      <div class="agreementActions">
        <button class="agreementBtn primary" id="agreeBtn">I Agree - Start Test</button>
        <button class="agreementBtn secondary" id="disagreeBtn">Cancel</button>
      </div>
    </div>
  </div>
  <div id="submissionOverlay">
    <div class="submissionCard">
      <div class="spinner"></div>
      <div class="submissionMsg" id="submissionMessage"></div>
    </div>
  </div>
  <div class="centered" id="loginContainer">
    <form id="loginBox" onsubmit="event.preventDefault(); login();">
      <h2>Test Portal Login</h2>
      <input type="text" id="studentId" placeholder="Student ID" required autocomplete="username" />
      <input type="password" id="password" placeholder="Password" required autocomplete="current-password" />
      <button id="loginBtn" type="submit">Login</button>
      <div id="loginLoading"><div class="spinner"></div></div>
      <div id="loginError"></div>
    </form>
  </div>
  <div id="dashboard">
    <div class="testHeader">
      <span><i class="fa-solid fa-book-open-reader"></i> Speaking TEST</span>
      <span class="ieltsMark">Official Format</span>

      <!-- Enhanced timer section -->
      <div id="timerContainer" style="display:none; margin-left: auto;">
        <i class="fas fa-clock"></i>
        <span id="timerDisplay">00:00:00</span>
      </div>
    </div>
    <div id="welcomeBar">
      <span class="userBadge">
        <i class="fa-solid fa-id-card"></i>
        <span id="studentIdDisplay"></span>
      </span>
      <span class="userBadge">
        <i class="fa-solid fa-user-graduate"></i>
        <span id="studentName"></span>
      </span>
    </div>
    <form id="testForm">
      <div id="questionsArea"></div>
      <button id="submitBtn" type="submit">Submit</button>
      <div id="submitLoading" style="display:none;"><div class="spinner"></div></div>
      <div id="scoreResult"></div>
    </form>
  </div>
  <script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwQknsM0MJwRmoTGPai-_E2OSMb9FPxK7UsexqmpXZAqelyw99guEhjhNQn9hCL0m5uTg/exec";
  
  function fixDropboxAudioUrl(url) {
    if (!url) return '';
    if (url.includes('raw=1')) return url;
    url = url.replace(/([&?]dl=[01])/, '');
    if (url.includes('?')) return url + '&raw=1';
    return url + '?raw=1';
  }

  let studentId = '';
  let password = '';
  let currentQuestions = [];
  let validRenderedQuestions = [];
  let submissionInterval;
  let testTimer;
  let testDuration = 0;
  let timeLeft = 0;
  let timerWarningShown = false;
  let timerFinalWarningShown = false;

  function fetchTimerConfig() {
    return fetch(`${SCRIPT_URL}?action=getTimerConfig`)
      .then(res => res.json())
      .then(data => {
        if (data.success && data.timerMinutes) {
          return parseInt(data.timerMinutes);
        } else {
          return 30; // fallback in case config not found
        }
      })
      .catch(() => 30); // fallback on network error
  }

  function login() {
    studentId = document.getElementById('studentId').value.trim();
    password = document.getElementById('password').value.trim();
    document.getElementById('loginError').textContent = '';
    document.getElementById('loginBtn').disabled = true;
    document.getElementById('loginLoading').style.display = "flex";

    fetch(SCRIPT_URL, {
      method: "POST",
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ action: "login", id: studentId, password: password })
    })
    .then(res => res.json())
    .then(res => {
      document.getElementById('loginBtn').disabled = false;
      document.getElementById('loginLoading').style.display = "none";
      if (res.success) {
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('studentName').textContent = formatName(res.name);
        document.getElementById('studentIdDisplay').textContent = studentId;
        
        if (res.restriction?.toUpperCase() === 'YES') {
          showRestriction(res.restrictionMessage || "Account Restricted");
        } else {
          // Show agreement popup before starting test
          showAgreementPopup();
        }
      } else {
        showError(res.message || "Login failed");
      }
    })
    .catch(() => {
      document.getElementById('loginBtn').disabled = false;
      document.getElementById('loginLoading').style.display = "none";
      showError("Network error. Please try again.");
    });
  }

  function showAgreementPopup() {
    const overlay = document.getElementById('agreementOverlay');
    overlay.style.display = 'flex';
    
    document.getElementById('agreeBtn').onclick = function() {
      if (document.getElementById('agreeCheckbox').checked) {
        overlay.style.display = 'none';
        startTest();
      } else {
        showAlert("Please agree to the terms to continue");
      }
    };
    
    document.getElementById('disagreeBtn').onclick = function() {
      overlay.style.display = 'none';
      document.getElementById('loginContainer').style.display = 'flex';
    };
  }

  function startTest() {
    fetchTimerConfig().then(minutes => {
      testDuration = 60 * 60; // 60 minutes
      timeLeft = testDuration;
      updateTimerDisplay();
      document.getElementById('timerContainer').style.display = 'flex';
      startTimer();
      fetchQuestions();
      document.getElementById('dashboard').style.display = 'block';
    });
  }

  function startTimer() {
    clearInterval(testTimer);
    testTimer = setInterval(() => {
      timeLeft--;
      updateTimerDisplay();
      
      if (timeLeft <= 300 && !timerWarningShown) {
        timerWarningShown = true;
        document.getElementById('timerContainer').classList.add('warning');
        showAlert("Warning: Only 5 minutes remaining!");
      }
      
      if (timeLeft <= 60 && !timerFinalWarningShown) {
        timerFinalWarningShown = true;
        document.getElementById('timerContainer').classList.remove('warning');
        document.getElementById('timerContainer').classList.add('danger');
        showAlert("Final Warning: Only 1 minute remaining!");
      }
      
      if (timeLeft <= 0) {
        clearInterval(testTimer);
        document.getElementById('timerContainer').classList.add('danger');
        document.getElementById('timerDisplay').textContent = "TIME'S UP!";
        showAlert("Time's up! Your test is being submitted automatically.");
        setTimeout(() => {
          document.getElementById('submitBtn').click();
        }, 2000);
      }
    }, 1000);
  }

  function updateTimerDisplay() {
    const hours = Math.floor(timeLeft / 3600);
    const minutes = Math.floor((timeLeft % 3600) / 60);
    const seconds = timeLeft % 60;
    
    document.getElementById('timerDisplay').textContent = 
      `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }

  function showAlert(message) {
    const alertBox = document.createElement('div');
    alertBox.style.position = 'fixed';
    alertBox.style.bottom = '20px';
    alertBox.style.left = '50%';
    alertBox.style.transform = 'translateX(-50%)';
    alertBox.style.backgroundColor = 'rgba(211, 44, 44, 0.9)';
    alertBox.style.color = 'white';
    alertBox.style.padding = '12px 24px';
    alertBox.style.borderRadius = '8px';
    alertBox.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
    alertBox.style.zIndex = '1000';
    alertBox.style.fontWeight = '600';
    alertBox.style.animation = 'fade-in 0.3s';
    alertBox.textContent = message;
    
    document.body.appendChild(alertBox);
    
    setTimeout(() => {
      alertBox.style.animation = 'fade-out 0.5s';
      setTimeout(() => {
        document.body.removeChild(alertBox);
      }, 500);
    }, 5000);
  }

  function showError(msg) {
    const e = document.getElementById('loginError');
    e.style.display = 'block';
    e.textContent = msg;
  }

  function showRestriction(msg) {
    const overlay = document.getElementById('restrictionOverlay');
    overlay.style.display = 'flex';
    overlay.innerHTML = `
      <div class="restrictCard">
        <div class="iconWrap">
          <i class="fa-solid fa-circle-exclamation" style="font-size:2.4rem;color:#d32c2c;"></i>
        </div>
        <div style="font-size:1.17rem;font-weight:700;color:#d32c2c;margin-bottom:0.5rem;">Access Restricted</div>
        <div class="restrictMsg">${msg}</div>
      </div>
    `;
    document.getElementById('dashboard').style.filter = 'blur(7px)';
  }

  function fetchQuestions() {
    fetch(SCRIPT_URL, {
      method: "POST",
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ action: "fetchQuestions", id: studentId, password: password })
    })
    .then(res => res.json())
    .then(res => {
      if (res.success && Array.isArray(res.questions)) {
        currentQuestions = res.questions;
        validRenderedQuestions = [];

        let out = '';
        res.questions.forEach((q, i) => {
          if (q.question && q.options && q.options.length > 0) {
            validRenderedQuestions.push(i);
            
            const questionText = q.question.length > 120 
              ? `<div class="long-paragraph">${q.question}</div>` 
              : q.question;
            
            const isDragDrop = q.type && q.type.toLowerCase() === 'dragdrop';
            
            out += `
              <div class="questionCard">
                <div style="font-weight:700;font-size:1.15rem;margin-bottom:.45em">${validRenderedQuestions.length}. ${questionText}</div>
                ${q.audio ? `
                <div class="audio-container">
                  <button type="button" class="audioBtn" id="audioBtn${i}" onclick="playAudio('${q.audio}', ${i});return false;">
                    <i class="fa-solid fa-headphones"></i> Play Audio
                  </button>
                  <div class="audio-progress"><div class="audio-progress-bar" id="audioProgress${i}"></div></div>
                  <div class="audio-time" id="audioTime${i}">0:00</div>
                </div>` : ''}
                <div style="margin-top:0.4rem;margin-bottom:0.15em;">
                  ${isDragDrop ? renderDragDropQuestion(q, i) : renderRadioOptions(q, i)}
                </div>
                <div id="result${i}" class="answerResult" style="display:none;"></div>
              </div>`;
          }
        });

        document.getElementById('questionsArea').innerHTML = out || '<div style="text-align:center;padding:2rem;">No valid questions found.</div>';
        document.getElementById('submitBtn').style.display = validRenderedQuestions.length ? "block" : "none";
        document.getElementById('scoreResult').style.display = "none";
        document.getElementById('testForm').style.paddingBottom = validRenderedQuestions.length ? '1rem' : '0';
        
        if (document.querySelector('.drag-drop-target')) {
          initDragDrop();
        }
      }
    })
    .catch(() => {
      document.getElementById('questionsArea').innerHTML = '<div style="text-align:center;padding:2rem;color:#d32c2c;">Error loading questions. Please try again.</div>';
      document.getElementById('submitBtn').style.display = "none";
    });
  }

  function renderRadioOptions(q, i) {
    return q.options.map((opt, idx) => `
      <label><input type="radio" name="q${i}" value="${String.fromCharCode(65+idx)}"> ${opt}</label>
    `).join('');
  }

  function renderDragDropQuestion(q, i) {
    return `
      <div class="drag-drop-container">
        <div class="drag-drop-options" id="dragOptions${i}">
          ${q.options.map((opt, idx) => `
            <div class="drag-option" draggable="true" data-value="${String.fromCharCode(65+idx)}">${opt}</div>
          `).join('')}
        </div>
        <div class="drag-drop-target" id="dragTarget${i}" data-question="${i}">
          Drop your answer here
        </div>
        <input type="hidden" name="q${i}" id="dragAnswer${i}" value="">
      </div>
    `;
  }

  function initDragDrop() {
    const targets = document.querySelectorAll('.drag-drop-target');
    
    targets.forEach(target => {
      target.addEventListener('dragover', (e) => {
        e.preventDefault();
        target.classList.add('active');
      });
      
      target.addEventListener('dragleave', () => {
        target.classList.remove('active');
      });
      
      target.addEventListener('drop', (e) => {
        e.preventDefault();
        target.classList.remove('active');
        
        const data = e.dataTransfer.getData('text/plain');
        const questionIndex = target.getAttribute('data-question');
        const answerInput = document.getElementById(`dragAnswer${questionIndex}`);
        
        if (data && answerInput) {
          target.innerHTML = '';
          
          const answerElement = document.createElement('div');
          answerElement.className = 'drag-option';
          answerElement.textContent = document.querySelector(`.drag-option[data-value="${data}"]`).textContent;
          answerElement.style.cursor = 'default';
          
          const removeBtn = document.createElement('button');
          removeBtn.innerHTML = '<i class="fas fa-times"></i>';
          removeBtn.style.background = 'none';
          removeBtn.style.border = 'none';
          removeBtn.style.marginLeft = '8px';
          removeBtn.style.cursor = 'pointer';
          removeBtn.style.color = '#d32c2c';
          removeBtn.onclick = () => {
            target.innerHTML = 'Drop your answer here';
            answerInput.value = '';
          };
          
          answerElement.appendChild(removeBtn);
          target.appendChild(answerElement);
          answerInput.value = data;
        }
      });
    });
    
    const options = document.querySelectorAll('.drag-option');
    options.forEach(option => {
      option.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', option.getAttribute('data-value'));
      });
    });
  }

  document.getElementById('testForm').addEventListener('submit', function(e) {
    e.preventDefault();
    clearInterval(testTimer);
    
    const submitBtn = document.getElementById('submitBtn');
    const overlay = document.getElementById('submissionOverlay');
    const msgBox = document.getElementById('submissionMessage');
    const studentName = document.getElementById('studentName').textContent;

    submitBtn.disabled = true;
    submitBtn.style.display = 'none';
    overlay.style.display = 'flex';

    const messages = [
      `⏳ Wait, ${studentName}! We're checking your answers...`,
      `🤔 Analyzing your responses carefully...`,
      `📊 Almost done! Calculating your score now...`,
      `🔍 Reviewing each question thoroughly...`,
      `📝 Finalizing your test results...`
    ];
    let index = 0;
    msgBox.textContent = messages[index];
    submissionInterval = setInterval(() => {
      index = (index + 1) % messages.length;
      msgBox.textContent = messages[index];
    }, 2000);

    setTimeout(() => {
      clearInterval(submissionInterval);
      overlay.style.display = 'none';

      const answers = validRenderedQuestions.map(qIndex => {
        const dragAnswer = document.getElementById(`dragAnswer${qIndex}`);
        if (dragAnswer && dragAnswer.value) return dragAnswer.value;
        
        const radios = document.getElementsByName(`q${qIndex}`);
        for (let r of radios) if (r.checked) return r.value;
        return '';
      });

      fetch(SCRIPT_URL, {
        method: "POST",
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          action: "submitTest",
          id: studentId,
          password: password,
          answers: JSON.stringify(answers)
        })
      })
      .then(res => res.json())
      .then(res => {
        if (res.success && Array.isArray(res.results)) {
          validRenderedQuestions.forEach((qIndex, i) => {
            const result = res.results[i];
            const resultDiv = document.getElementById(`result${qIndex}`);
            if (!resultDiv) return;
            resultDiv.style.display = 'inline-block';
            if (result.isCorrect) {
              resultDiv.className = 'answerResult answerCorrect';
              resultDiv.innerHTML = `<i class="fa-solid fa-circle-check"></i> Correct! +${result.scoreValue}`;
            } else {
              resultDiv.className = 'answerResult answerWrong';
              resultDiv.innerHTML = `<i class="fa-solid fa-circle-xmark"></i> Wrong!<br><span style="font-size:0.98em;font-weight:500;">Correct: <b>${result.correctAnswer}</b></span>`;
            }
          });

          // Enhanced score display with screenshot button
          document.getElementById('scoreResult').innerHTML = `
            <div class="score-header">
              <div class="score-user">
                <i class="fas fa-user-graduate"></i> ${document.getElementById('studentName').textContent}
              </div>
            </div>
            <div class="score-label">YOUR TEST RESULTS</div>
            <div class="score-value">${res.score}</div>
            <div class="score-details">
              <div class="score-detail-item">
                <div class="score-detail-value">${res.totalPoints}</div>
                <div class="score-detail-label">Total Points</div>
              </div>
              <div class="score-detail-item">
                <div class="score-detail-value">${validRenderedQuestions.length}</div>
                <div class="score-detail-label">Questions</div>
              </div>
              <div class="score-detail-item">
                <div class="score-detail-value">${Math.round((res.score / res.totalPoints) * 100)}%</div>
                <div class="score-detail-label">Accuracy</div>
              </div>
            </div>
            <button class="screenshot-btn" onclick="captureResult()">
              <i class="fas fa-camera"></i> Save Your Result
            </button>
          `;
          document.getElementById('scoreResult').style.display = "block";
        } else {
          document.getElementById('scoreResult').textContent = res.message || "Submission failed.";
          document.getElementById('scoreResult').style.display = "block";
          submitBtn.style.display = "block";
          submitBtn.disabled = false;
        }
      })
      .catch(() => {
        document.getElementById('scoreResult').textContent = "Error submitting answers. Please try again.";
        document.getElementById('scoreResult').style.display = "block";
        submitBtn.style.display = "block";
        submitBtn.disabled = false;
      });
    }, 6000);
  });

  function formatName(name) {
    if (!name) return '';
    return name.split(' ').map(part =>
      ['mr', 'mrs', 'ms', 'dr', 'prof'].includes(part.toLowerCase())
        ? part.charAt(0).toUpperCase() + part.slice(1).toLowerCase()
        : part.charAt(0).toUpperCase() + part.slice(1).toLowerCase()
    ).join(' ');
  }

  let currentAudio = null;
  let currentAudioIndex = null;

  function playAudio(url, index) {
    const btn = document.getElementById(`audioBtn${index}`);
    btn.classList.add('loading');
    
    // Show loading state for 500ms minimum
    setTimeout(() => {
      url = fixDropboxAudioUrl(url);

      if (currentAudio && !currentAudio.paused) {
        currentAudio.pause();
        if (typeof currentAudioIndex === "number") {
          const prevBtn = document.getElementById(`audioBtn${currentAudioIndex}`);
          prevBtn?.classList.remove('playing', 'loading');
          const prevBar = document.getElementById(`audioProgress${currentAudioIndex}`);
          prevBar && (prevBar.style.width = '0%');
          const prevTime = document.getElementById(`audioTime${currentAudioIndex}`);
          prevTime && (prevTime.textContent = '0:00');
        }
      }

      currentAudio = new Audio(url);
      currentAudioIndex = index;
      btn.classList.remove('loading');
      btn.classList.add('playing');

      const progressBar = document.getElementById(`audioProgress${index}`);
      const timeDisplay = document.getElementById(`audioTime${index}`);

      currentAudio.addEventListener('timeupdate', function () {
        if (progressBar && currentAudio.duration) {
          progressBar.style.width = ((currentAudio.currentTime / currentAudio.duration) * 100) + '%';
        }
        if (timeDisplay) {
          const mins = Math.floor(currentAudio.currentTime / 60);
          const secs = Math.floor(currentAudio.currentTime % 60).toString().padStart(2, '0');
          timeDisplay.textContent = `${mins}:${secs}`;
        }
      });

      currentAudio.addEventListener('ended', function () {
        btn.classList.remove('playing');
        if (progressBar) progressBar.style.width = '0%';
        if (timeDisplay) timeDisplay.textContent = '0:00';
      });

      currentAudio.addEventListener('error', function() {
        btn.classList.remove('playing', 'loading');
        showAlert("Error playing audio. Please try again.");
      });

      currentAudio.play().catch(() => {
        btn.classList.remove('playing', 'loading');
        showAlert("Could not play audio. Please check your connection.");
      });
    }, 500);
  }

  function captureResult() {
    const resultElement = document.getElementById('scoreResult');
    if (!resultElement) return;

    // Use html2canvas library to capture the result
    if (typeof html2canvas !== 'undefined') {
      html2canvas(resultElement, {
        scale: 2,
        logging: false,
        useCORS: true,
        allowTaint: true
      }).then(canvas => {
        const link = document.createElement('a');
        link.download = `IELTS-Result-${studentId}-${new Date().toISOString().slice(0,10)}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      });
    } else {
      // Fallback if html2canvas is not loaded
      showAlert("Screenshot feature requires html2canvas library. Please contact support.");
    }
  }

  // Load html2canvas library dynamically if not already loaded
  if (typeof html2canvas === 'undefined') {
    const script = document.createElement('script');
    script.src = 'https://html2canvas.hertzen.com/dist/html2canvas.min.js';
    script.onload = function() {
      console.log('html2canvas loaded successfully');
    };
    script.onerror = function() {
      console.log('Failed to load html2canvas');
    };
    document.head.appendChild(script);
  }

  // Add fade-out animation for alerts
  const style = document.createElement('style');
  style.textContent = `
    @keyframes fade-out {
      0% { opacity: 1; transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) translateY(20px); }
    }
  `;
  document.head.appendChild(style);
  </script>
</body>
</html>